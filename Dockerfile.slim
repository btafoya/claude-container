# Use Ubuntu LTS as base image for better compatibility
FROM ubuntu:24.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONPATH="/opt/superclaude:$PYTHONPATH" \
    NODE_PATH="/usr/lib/node_modules:$NODE_PATH" \
    CLAUDE_CONFIG_DIR=/claude \
    SUPERCLAUDE_HOME=/opt/superclaude \
    CLAUDECODEUI_HOME=/opt/claudecodeui \
    PATH="/root/.local/bin:$PATH" \
    VITE_PORT=5173 \
    PORT=3000

# Define build arguments for user credentials
ARG UBUNTU_USERNAME=developer
ARG UBUNTU_PASSWORD=changeme123

# Install essential dependencies, Python, Node.js, and create user
RUN apt-get update && apt-get install -y \
    curl wget git build-essential ca-certificates \
    python3 python3-pip python3-venv python3-dev \
    && rm -rf /var/lib/apt/lists/* \
    && ln -sf /usr/bin/python3 /usr/bin/python \
    && ln -sf /usr/bin/pip3 /usr/bin/pip \
    && python3 -m pip install --upgrade --break-system-packages --ignore-installed pip setuptools wheel \
    && pip install --break-system-packages uv \
    && curl -fsSL https://deb.nodesource.com/setup_22.x | bash - \
    && apt-get install -y nodejs \
    && rm -rf /var/lib/apt/lists/* \
    && useradd -m ${UBUNTU_USERNAME} \
    && echo "${UBUNTU_USERNAME}:${UBUNTU_PASSWORD}" | chpasswd

# Install essential Node.js packages
RUN npm install -g \
    @anthropic-ai/claude-code \
    claude-conductor \
    typescript ts-node \
    yarn pnpm \
    @playwright/test \
    && npx -y playwright@latest install --with-deps

# Install essential Python packages
RUN pip install --no-cache-dir --break-system-packages \
    numpy pandas \
    requests \
    python-dotenv \
    fastapi uvicorn

# Clone and setup repositories
RUN git clone https://github.com/SuperClaude-Org/SuperClaude_Framework /opt/superclaude \
    && cd /opt/superclaude \
    && ([ -f requirements.txt ] && pip install --break-system-packages -r requirements.txt || true) \
    && ([ -f package.json ] && npm install || true) \
    && git clone https://github.com/btafoya/claudecodeui /opt/claudecodeui \
    && cd /opt/claudecodeui \
    && npm install \
    && ([ -f .env.example ] && cp .env.example .env || true) \
    && mkdir -p /claude /workspace /home/${UBUNTU_USERNAME}/.claude /home/${UBUNTU_USERNAME}/.config \
    && chown -R ${UBUNTU_USERNAME}:${UBUNTU_USERNAME} /claude /workspace /home/${UBUNTU_USERNAME} /opt/claudecodeui

# Create startup script
RUN cat > /startup.sh <<'EOF'
#!/bin/bash
# Set up environment
export HOME=/root
export PATH="/opt/superclaude/bin:$PATH"

# Initialize SuperClaude if needed
if [ -d "/opt/superclaude" ]; then
    echo "SuperClaude Framework available at /opt/superclaude"
fi

# Initialize claudecodeui if needed
if [ -d "/opt/claudecodeui" ]; then
    echo "ClaudeCodeUI available at /opt/claudecodeui"
    echo "To start ClaudeCodeUI: cd /opt/claudecodeui && npm run dev"
fi

# Check installed tools
echo "=== Installed Tools ==="
which claude && echo "✓ Claude Code is available"
which claude-conductor && echo "✓ claude-conductor is available"
which uv && echo "✓ uv/uvx Python tool runner is available"
which playwright && echo "✓ Playwright is available"
python3 --version && echo "✓ Python is available"
node --version && echo "✓ Node.js is available"

# Keep container running
tail -f /dev/null
EOF
RUN chmod +x /startup.sh

# Expose ports for claudecodeui
EXPOSE 5173 3000

# Set working directory
WORKDIR /workspace

# Start services using JSON format
CMD ["/bin/bash", "/startup.sh"]